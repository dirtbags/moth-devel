# Hey, Neale, versioning this is kind of problematic!
FROM dirtbags/moth:v4.2 AS moth

# Python library
FROM python:3.8-slim-buster AS builder-python
RUN	apt-get update && \
	apt-get upgrade -y && \
	apt-get clean all && \
	rm -rf /var/lib/apt/lists/*
WORKDIR /build
COPY    lib/python /build
# I apologize for this. Python's build system baffles me.
RUN ln -s . /build/python
RUN	python setup.py bdist_wheel


# The main thing
FROM ubuntu:rolling as moth-devel

# Upgrade image packages, install dependencies for some Python libraries which might not have binaries on all platforms
RUN	apt-get update && apt-get upgrade -y
RUN apt-get install -y --no-install-recommends \
	    python3-pip \
		gcc \
		libjpeg-dev \
		zlib1g-dev \
	&& \
	apt-get clean all && \
	rm -rf /var/lib/apt/lists/*

COPY --from=moth /puzzles/ /puzzles/
COPY --from=moth /state/ /state/
COPY --from=moth /bin/ /bin/
COPY --from=builder-python /build/dist/moth-*.whl /moth/
COPY puzzles/ /puzzles/
COPY theme/ /theme/


# Use this hackish way to find the wheel file, because pip doesn't like globs
RUN	find /moth/ -type f -iname '*.whl' | xargs -I '{}' pip install {}[scapy,pillow]

WORKDIR /
CMD [ "/bin/mothd", "-puzzles", "/puzzles" ]

